<center><font size="6">网关通信协议</font></center>

| 版本 | 修订日期 | 内容变更 | 作者 |
| - | - | - | - |
| 1.0.0 | 2019/12/18 | 初始版本：协议格式、通用协议、简易中餐、附录 a - e | 卜伟伟 |
| 1.0.1 | 2019/12/25 | 修改版本：火锅、中餐、快餐的设备类型定义、异常状态码定义 附录 b - e | 蔡俊伟 |

# 一、协议格式

## 1.1. 基本协议格式

|  |  |  |  |  |  |  |  |
| - | - | - | - | - | - | - | - |
|  | Header | Data Length | Message Type | Unique Key | Device Type | Device ID | Content |
| 长度(字) | 1 | 1 | 1 | 1 | 1 | 1 | 0..n |

各字段说明：

| 字段 | 描述 |
| - | - |
| Header | 消息头，预留字段，目前取值与 Device Type 相同 |
| Data Length | 整个报文的长度，取值为总字长*2，例如 Content=0 时，Data Length=12 |
| Message Type | 消息类型，参考附录 [a. 消息类型](#a-消息类型) |
| Unique Key | 唯一标识码，在一段时间内需唯一 |
| Device Type | 设备类型，参考附录 [b. 设备类型](#b-设备类型) |
| Device ID | 设备 ID，在同一个门店需唯一 |
| Content | 扩展内容，可空 |

## 1.2. 业务请求协议格式

**所有客户端->服务端的业务请求(消息类型=1)均需要满足业务请求协议格式**

业务请求协议是对基本协议 Content 部分的二次扩展，格式如下：

|  |  |  |  |  |  |  |  |
| - | - | - | - | - | - | - | - |
|  | 基本协议 | Device Sub Type | Control Mode | Device Status | Exception Status | Request | Content |
| 长度(字) | 6 | 1 | 1 | 1 | 1 | 1 | 0..n |

各字段说明：

| 字段 | 描述 |
| - | - |
| 基本协议 | 基本协议，参考 [1.1. 基本协议格式](#11-基本协议格式) |
| Device Sub Type | 设备子类型，目前为预留字段 |
| Control Mode | 控制模式，参考附录 [c. 控制模式](#c-控制模式) |
| Device Status | 设备状态,参考附录 [d. 设备状态](#d-设备状态) |
| Exception Status | 异常状态，参考附录 [e. 异常状态](#e-异常状态) |
| Request | 请求信息，具体含义在各个协议详细定义 |
| Content | 扩展内容，可空 |

## 1.3. 业务请求协议(包含报警信息)格式

**所有客户端->服务端的业务请求(消息类型=1)包含报警信息的均需要满足业务请求协议(包含报警信息)格式**

业务请求协议(包含报警信息)是对业务请求协议 Content 部分的二次扩展，格式如下：

|  |  |  |  |
| - | - | - | - |
|  | 业务请求协议 | Warning Info | Content |
| 长度(字) | 11 | 4 | 0..n |

各字段说明：

| 字段 | 描述 |
| - | - |
| 业务请求协议 | 业务请求协议，参考 [1.2. 业务请求协议格式](#12-业务请求协议格式) |
| Warning Info | 报警信息 |
| Content | 扩展内容，可空 |

# 二、通用协议

## 2.1. 登录请求

**客户端与服务端建立通信后，首先必须发送登录请求**

协议格式见 [1.1. 基本协议格式](#11-基本协议格式)，其中 Content 为空

## 2.2. 登录回复

与 [2.1. 登录请求](21-登录请求) 相同

## 2.3. 心跳

|  |  |  |  |  |
| - | - | - | - | - |
|  | 基本协议 |
| 长度(字) | 6 |

各字段说明：

| 字段 | 描述 |
| - | - |
| 基本协议 | 基本协议，参考 [1.1. 基本协议格式](#11-基本协议格式) |


## 2.4. 心跳回复

与 [2.1. 登录请求](21-登录请求) 相同

## 2.5. 业务请求回复

默认与 [2.1. 登录请求](21-登录请求) 相同，如无特殊说明则采用此格式；**如果不是此回复格式则特殊说明**

# 三、业态协议

## 3.1. 简易中餐

### 3.1.1. 简易中餐-烹饪设备(炒锅)-业务请求/信息上报

|  |  |  |
| - | - | - |
|  | 业务请求协议(包含报警信息) | 菜品 ID |
| 长度(字) | 15 | 2 |

各字段说明：

| 字段 | 描述 |
| - | - |
| 业务请求协议(包含报警信息) |业务请求协议(包含报警信息)，参考 [1.3. 业务请求协议(包含报警信息)格式](#13-业务请求协议(包含报警信息)格式) |

Request 代码：

| 代码 | 描述 |
| - | - |
| 1 | 信息上报 |
| 2 | 制作完成信息标志(统计) |
| 3 | 获取烹饪参数 |
| 4 | 获取菜品图片(预留) |
| 5 | 获取菜品名称(预留) |
| 6 | 获取服务器时间(预留) |

Request=3 时回复报文：

|  |  |  |
| - | - | - |
|  | 基本协议 | 烹饪参数 |
| 长度(字) | 6 | 0..n |

### 3.1.2. 简易中餐-冷库-业务请求/信息上报

|  |  |  |  |  |  |  |  |
| - | - | - | - | - | - | - | - |
|  | 业务请求协议(包含报警信息) | 任务状态 | 任务 ID | 菜品 ID | 出料层数(第几层) | 出料列数(第几列) | 出料状态 |
| 长度(字) | 15 | 1 | 4 | 2 | 1 | 1 | 1 |

各字段说明：

| 字段 | 描述 |
| - | - |
| 业务请求协议(包含报警信息) |业务请求协议(包含报警信息)，参考 [1.3. 业务请求协议(包含报警信息)格式](#13-业务请求协议(包含报警信息)格式) |

Request 代码：

| 代码 | 描述 |
| - | - |
| 1 | 信息上报 |

任务状态代码：

| 代码 | 描述 |
| - | - |
| 0 | 无任务 |
| ~~1~~ | ~~任务开始(弃用)~~ |
| 2 | 任务进行中 |
| 3 | 任务完成 |
| 4 | 取餐成功 |
| 5 | 烹饪失败 |

出料状态代码：

| 代码 | 描述 |
| - | - |
| 0 | 无出料 |
| 1 | 出料成功 |
| 2 | 出料失败 |

### 3.1.3. 简易中餐-冷库-服务端下发烹饪命令

|  |  |  |  |  |  |  |  |  |  |
| - | - | - | - | - | - | - | - | - | - |
|  | 基本协议 | 下发类型 | 炒锅 ID | 任务 ID |  菜品 ID | 料盒数 | 出料顺序 | 出料层数(第几层) | 出料列数(第几列) |
| 长度(字) | 6 | 1 | 1 | 4 | 2 | 1 | 1 | 1 | 1 |

**出料顺序、出料层数(第几层)、出料列数(第几列) 根据料盒数动态变化**

各字段说明：

| 字段 | 描述 |
| - | - |
| 基本协议 | 基本协议，参考 [1.1. 基本协议格式](#11-基本协议格式) |

下发类型代码：

| 代码 | 描述 |
| - | - |
| 1 | 烹饪制作 |


# 附录

## a. 消息类型

| 代码 | 描述 |
| - | - |
| 0 | 心跳 |
| 1 | 业务请求 |
| 2 | 业务请求回复 |
| 3 | 心跳回复 |
| 4 | 结果回复 |
| 5 | 登录请求 |
| 6 | 登录回复 |

## b. 设备类型

设备类型使用四位十六进制标识，取值范围 0x0000 ~ 0x7FFF，前两位标识类别，后两位标识子类别

| 代码 | 描述 | 十进制值 |
| - | - | - |
| **0x10** | **烹饪设备** | |
| 0x1001 | 烹饪设备(简易中餐) | 4097 |
| 0x1002 | 烹饪设备(中餐厅) | 4098 |
| **0x11** | **冷库设备** | |
| 0x1101 | 冷库设备(简易中餐) | 4353 |
| 0x1102 | 冷库设备(火锅店) | 4354 |
| 0x1103 | 冷库设备(中餐厅) | 4355 |
| 0x1104 | 蒸箱冷库设备(快餐厅) | 4355 |
| **0x12** | **餐桌设备** | |
| 0x1201 | 餐桌设备(火锅店) | 4609 |
| **0x13** | **物流线设备** | |
| 0x1301 | 物流线设备(火锅店) | 4865 |
| 0x1302 | 自动物流线设备(快餐厅) | 4866 |
| 0x1303 | 人工物流线设备(快餐厅) | 4867 |
| 0x1304 | 一体化物流线主控设备(快餐厅) | 4867 |
| 0x1305 | 自助式物流线主控设备(快餐厅) | 4868 |
| **0x13** | **三合一汉堡设备** | |
| 0x1310 | 汉堡机-汉堡设备 | 4880 |
| 0x1311 | 汉堡机-披萨设备 | 4881 |
| 0x1312 | 汉堡机-饮料设备 | 4882 |
| **0x14** | **人工上菜口设备** | |
| 0x1401 | 人工上菜口设备(火锅店) | 5121 |
| 0x1402 | 上菜口设备(中餐厅) | 5122 |
| **0x15** | **切菜口设备** | |
| 0x1501 | 切菜口设备(火锅店) | 5377 |
| **0x16** | **饮料机设备** | |
| 0x1601 | 饮料机设备(火锅店) | 5633 |
| **0x17** | **下菜口设备** | |
| 0x1701 | 下菜口设备(中餐厅) | 5889 |
| **0x18** | **煲仔饭设备** | |
| 0x1801 | 煲仔饭设备(中餐厅) | 6145 |
| **0x19** | **蒸箱设备** | |
| 0x1901 | 蒸箱设备(中餐厅) | 6401 |
| **0x1A** | **保温设备** | |
| 0x1A01 | 保温设备(快餐厅) | 6657 |
| 0x1A02 | 水保温柜设备(快餐厅) | 6658 |
| **0x1B** | **取餐柜设备(未启用)** | |
| 0x1B01 | 取餐柜设备(快餐厅) | 6657 |
| **0x1C** | **扫码设备** | |
| 0x1C01 | 扫码设备 | 7169 |
| **0x1D** | **调酒机设备** | |
| 0x1D01 | 扫码设备 | 7425 |
| **0x20** | **机械臂表情设备** | |
| 0x2001 | 机械臂表情设备 | 8193 |
| **0x21** | **粉面机设备** | |
| 0x2101 | 粉面机-煮池模块 | 8449 |
| 0x2102 | 粉面机-浇头机 | 8450 |
| 0x2103 | 粉面机-半自动 | 8451 |
| **0x22** | **单机饮品店设备** | |
| 0x2201 | 饮品机-制作模块 | 8705 |
| 0x2202 | 饮品机-冷库模块 | 8706 |
| 0x2203 | 饮品机-取餐口模块 | 8707 |
| 0x2204 | 饮品机-扫码枪模块 | 8708 |
| **0x40** | **麻辣烫设备备** | |
| 0x4001 | 麻辣烫-称重台 | 16385 |
| 0x4002 | 麻辣烫-电磁炉 | 16386 |
| 0x4003 | 麻辣烫-机械手 | 16387 |


## c. 控制模式

| 代码 | 描述 |
| - | - |
| 1 | 自动模式 |
| 2 | 手动模式 |

## d. 设备状态

| 代码 | 描述 |
| - | - |
| 1 | 空闲 |
| 2 | 运行中 |


## e. 异常状态

| 代码 | 描述 |
| - | - |
| 1 | 正常 |
| 2 | 异常 |
| 3 | 故障 |
| 4 | 急停 |
| 5 | 缺盘 |
| 6 | 获取菜肴失败 |
| 7 | 锁定 |
| 8 | 菜品不良 |
| 9 | 缺料 |

